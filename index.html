<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Add these tags to prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- End of tags to prevent caching -->
    
    <title>TM Object Detector</title>
    <!-- Load Tailwind CSS for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* No longer mirroring the video, so this rule is removed */
        /*
        #webcam {
            transform: scaleX(-1);
            -webkit-transform: scaleX(-1);
        }
        */
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4 font-sans">

    <h1 class="text-3xl font-bold mb-4">Object Detector</h1>
    <p class="text-gray-400 mb-6">Using Teachable Machine Model</p>

    <!-- Button to start the webcam -->
    <button id="start-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-lg transition-all">
        Start Camera
    </button>

    <!-- The video element will show the webcam feed -->
    <!-- 'playsinline' and 'muted' are crucial for mobile browsers -->
    <video id="webcam" class="hidden rounded-lg shadow-xl mt-4" width="400" height="400" autoplay playsinline muted></video>
    
    <!-- This div will hold the prediction results -->
    <div id="label-container" class="mt-6 text-2xl w-full max-w-md space-y-2 text-center"></div>

    <!-- Add the new button here -->
    <a href="https://sialaichai.github.io/calculator-scanner/"
       class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition-all">
        Switch to OCR
    </a>

    <!-- Load TensorFlow.js and the Teachable Machine Image model -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script type="text/javascript">
        // URL to your Teachable Machine model
        // This is the model you trained!
        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/g2nm_zlLp/";

        let model, videoElement, labelContainer, maxPredictions;

        const startButton = document.getElementById("start-button");
        videoElement = document.getElementById("webcam"); // Assign to global
        const labelContainerElement = document.getElementById("label-container");

        startButton.addEventListener("click", () => init());

        // Load the image model and setup the webcam
        async function init() {
            startButton.classList.add("hidden"); // Hide the start button
            
            const modelURL = MODEL_URL + "model.json";
            const metadataURL = MODEL_URL + "metadata.json";

            // Load the model and metadata
            try {
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                // Define constraints to use the rear camera ("environment")
                // Use 'exact' to strongly require the rear camera
                const constraints = {
                    video: {
                        facingMode: { exact: "environment" }
                    }
                };

                // Manually get the camera stream
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Attach the stream to the video element
                videoElement.srcObject = stream;
                videoElement.classList.remove("hidden");
                
                // Wait for the video to start playing
                await videoElement.play();
                
                // Create label containers -
                // We will now just show a waiting message
                labelContainerElement.innerHTML = `<div class="text-gray-500">Aim camera at an object...</div>`;
                
                // Start the prediction loop
                window.requestAnimationFrame(loop);
            } catch (e) {
                console.error("Error initializing model or webcam:", e);
                // Show a user-friendly error
                let errorMsg = "Failed to start camera.";
                if (e.name === "OverconstrainedError" || e.name === "ConstraintNotSatisfiedError") {
                    errorMsg = "Could not find a rear camera. Please use a different device or browser.";
                } else if (e.name === "NotAllowedError") {
                    errorMsg = "Camera permission denied. Please enable it in your browser settings.";
                }
                labelContainerElement.innerHTML = `<div class="text-red-500 text-center">${errorMsg}</div>`;
                startButton.classList.remove("hidden"); // Show start button again
            }
        }

        // Main prediction loop
        async function loop() {
            // We no longer call webcam.update()
            await predict();
            window.requestAnimationFrame(loop);
        }

        // Run the webcam frame through the image model
        async function predict() {
            // predict can take in an image, video or canvas html element
            // We now pass the videoElement directly
            const prediction = await model.predict(videoElement);
            
            // Find the prediction with the highest probability
            let topPrediction = prediction[0];
            for (let i = 1; i < maxPredictions; i++) {
                if (prediction[i].probability > topPrediction.probability) {
                    topPrediction = prediction[i];
                }
            }

            // Check if the top prediction's probability is over 70%
            if (topPrediction.probability > 0.7) {
                // Display the top prediction
                const className = topPrediction.className;
                const probability = (topPrediction.probability * 100).toFixed(0);

                // Update the label container with the top class and its score
                labelContainerElement.innerHTML = `
                    <div class="bg-gray-800 p-4 rounded-lg shadow-inner">
                        <span class="text-3xl font-bold text-white">${className}</span>
                        <span class="text-xl text-blue-400 ml-4">${probability}%</span>
                    </div>
                `;
            } else {
                // If no prediction is over 70%, show the waiting message
                labelContainerElement.innerHTML = `<div class="text-gray-500">Aim camera at an object...</div>`;
            }
        }
    </script>
</body>
</html>
